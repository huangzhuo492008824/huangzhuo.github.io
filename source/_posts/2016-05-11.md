
---
date: 2016-05-11 18:30:58
categories: python
title: slack-alert把定时任务的结果发送slack消息的微框架
tags: [python]
---
#### 前言
为什么要做[slack-alert](https://github.com/dongweiming/slack-alert)呢?
成因其实是我一直想做的AST相关的一个项目.  
正好是一个机会. 其次也是业务需要:
工程师都比较懒, 在每天的各种问题邮件几百几千封的时候会经常遗漏重要的邮件. 会经常被用户以及公司其他同事发现问题时@到时候才发现.  
现在大家也接受了slack这个工具. 那么我就在想何不把更重要的消息发送到slack里呢.
原来也做过, 就是写一些脚本,
会把运行的结果通过[slacker](https://github.com/os/slacker)里面封装的[postMessage](https://api.slack.com/methods/chat.postMessage)发消息进来.  
先说一下为什么我不用[Incoming-webhooks](https://api.slack.com/incoming-webhooks). 最主要的,
因为通常slack都是用的免费版, 我担心对webhooks会有限制或者未来会有限制.
但是为什么做这个`微框架`呢? 一则这样的脚本和任务会越来越多, 脚本需要设置的定时任务的间隔也会各不相同. 用系统自带的crontab,
每次新增修改删除都要去做调整.  
代码还需要做抽象; 用celery, rq这些其实一是很浪费, 二也不怎么应景. 所以我写了这个工具.
#### 优点和特点
  1. 只支持python3
  2. 支持多种调度模式: AsyncIOScheduler, BackgroundScheduler, GeventScheduler, TornadoScheduler. 默认是AsyncIO
  3. 使用[AST](https://docs.python.org/3/library/ast.html), 而没有直接import代码.
  4. 代码和项目无关, 没有register. 只需要按格式编写plugin脚本即可, 要被执行的任务加一个装饰器(只需要他是一个装饰器, 不需要存在). 指定运行的间隔就好
  5. 附带常用的配置
#### 安装

``` python    
    
    pip install slack-alert  
      
```
  
slack-alert有个默认的配置[slack_alert.conf](https://github.com/dongweiming/slack-
alert/blob/master/slack_alert.conf).  
使用`OS X`或者`linux`可以拷贝到 `~/.config/slack_alert.conf`
#### 编写插件
PS: 插件目录默认是当前目录的`plugins`子目录下.

``` python    
    
    tree plugins  
    plugins  
    ├── examples.py  
      
    0 directories, 1 files  
      
```
  
``` python    
    
    # coding=utf-8  
    import os  
      
      
    @deco(seconds=2)  # 这个一个正确格式的任务, 因为装饰器里面包含`hours|seconds|minutes|days`这样的键.  
    def a():  
        print(1)  # 插件也需要python3的语法  
        print(os)  # 可以使用外部的变量  
        return 1  # 这个返回值最后会被发送到slack的channel里面  
      
      
    def b():  # 这个函数因为没有对应的格式的装饰器 他不会被当做一个任务  
        print(3)  
        return 2  
      
      
    @deco2(xx=1)  
    @deco(minutes=2, seconds=30)  
    def c():  # 这个函数也不是一个正确格式的装饰器. 我需要把`deco`放在最外面  
        print(4)  
        return 3  
      
```
  
PS: 大家不要迷惑为什么`deco`这个函数没有介绍. 因为我只需要这个代码文本. 我其实不直接运行这个脚本. 所以不需要装饰器存在.
#### 使用

``` python    
    
    slack-alert  
      
```
  
这样就启动了.
`a`这个函数就会每隔2秒运行一次， 运行三次后, 停顿60分钟… 这样循环(高级用法看下面的参数). 并且把结果发送到slack里面
#### 原理
  1. 启动`slack-alert` 我首先加载配置.
  2. 我会根据配置`--path`去找我应该去哪个文件目录下(默认是当前目录)的`plugins`子目录下去找符合的任务程序.
  3. 加载符合的目录下的每个python文件. 生成一个AST(抽象语法树).
  4. 遍历这棵树. 找到符合我需要的语法的函数. 去掉这个实际不存在的装饰器. 编译源码并且执行. 生成一个命名空间
  5. 获取这个命名空间的参数, 通过[apscheduler](http://apscheduler.readthedocs.org/en/latest/). 添加一个任务
  6. 添加全部任务. 再添加一个监控这些任务的任务(主要是用来在某些时机停掉/启动其他某些任务)
  7. 启动任务调度. 直到`Ctrl+C`
#### 高级选项
可以参照源码的选项:
  1. [Config file”s Options](https://github.com/dongweiming/slack-alert#config-files-options)
  2. [Command Options](https://github.com/dongweiming/slack-alert#command-options)

版权声明：本文由 董伟明 原创，未经作者授权禁止任何微信公众号和向掘金(juejin.im)转载，[技术博客转载采用 保留署名-非商业性使用-禁止演绎 4.0-国际许可协议](https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh)
python

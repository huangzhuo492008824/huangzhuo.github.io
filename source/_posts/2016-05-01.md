
---
date: 2016-05-01 18:30:58
categories: python
title: 使用Github_webhook服务实现提PR自动检查Flake8并在对应位置发评论
tags: [python]
---
最近参考[linty_fresh](https://github.com/lyft/linty_fresh)实现了一个webhook服务,  
提PR自动检查Flake8, 当有代码风格问题的时候,并在对应位置发评论
项目地址是: [gandalf](https://github.com/dongweiming/gandalf)
在公司内的Github企业版上, 已经用了一段时间, 比较稳定. 现在开源出来, 有兴趣的可以拿去^.^
这个项目也是我的学习asyncio的练手作品, 吐槽下[Type
Hints](https://www.python.org/dev/peps/pep-0484/)让代码显的好丑哇…
### 项目知识点
  1. Python3: 项目需要使用Python3， 建议使用Python3.5
  2. [rq](https://github.com/nvie/rq): 工作中有一些项目的版本库很大, 实际的检查时间也会长一些, 为了保证应用解耦和更好的提供支持, 使用rq作为任务队列
  3. [aiohttp](https://github.com/KeepSafe/aiohttp): 基于asyncio的http库, 用来调用github api, 获取对应pr信息
  4. [pygit2](https://github.com/libgit2/pygit2): 使用官方模块实现Python版本的git版本控制功能, 它的安装比较麻烦, 但是官方文档讲的很清楚
  5. Flask: 作为webhook的服务框架
来几张截图看个效果:
![](https://cloud.githubusercontent.com/assets/841395/12537409/649e9e24-c2f9-11e5-852c-60c189cd3140.png)  
![](https://cloud.githubusercontent.com/assets/841395/12537410/64e16150-c2f9-11e5-95f5-5711ddf82878.png)  
![](https://cloud.githubusercontent.com/assets/841395/12537411/64fff62e-c2f9-11e5-84cc-c5c2f44482aa.png)
### 配置

``` python    
    
    ❯ cat gandalf/config.py  
    WORK_DIR = '/tmp/repositories'  # 设定克隆的项目版本库代码存放位置  
    FLAKE8_EXECUTABLE = '/usr/local/bin/flake8'  # 这个项目时Python3的，但是目前大部分应用还是Python2的, 所以需要Python2版本的flake8  
    HOST = '0.0.0.0'  
    PORT = 8080  
    DEBUG = False  
    REPORT_NO_MATCHING = False  # 没有在diff列表的文件的错误是否也报告  
    GITHUB_URL = 'http://github.com/'  # 行尾要加反斜杠  
    GITHUB_API_URL = 'https://api.github.com'  # 行尾不要加反斜杠  
    REPORT_CLOSEST = False # 错误出现在PR列出的文件中, 但是修改并不是此次PR中的diff里面是否报告  
    COMMENT_HEADER = ''  # 上述截图出现的emoji头部就是指定它, 我的设置是`COMMENT_HEADER = ':sparkles:Subject Bot:sparkles:'`  
      
      
    try:  
        from local_settings import *  
    except ImportError:  
        pass  
      
```
  
### 配置webhook
需要在github的项目/组织设置页，找到`Webhooks`, 然后`Add webhook`，
  1. `Payload URL`输入 <http://192.168.1.1:28030/api/hooks> # 或者你跑起来web服务的地址
  2. 选择事件 ，`Let me select individual events.` 然后勾选`Pull Request`
如图:
![](https://cloud.githubusercontent.com/assets/841395/12540180/6d6fca82-c33f-11e5-9414-19121d5469db.png)  
![](https://cloud.githubusercontent.com/assets/841395/12540179/6d6ef15c-c33f-11e5-9e90-e93c810d69b9.png)
Enjoy it

版权声明：本文由 董伟明 原创，未经作者授权禁止任何微信公众号和向掘金(juejin.im)转载，[技术博客转载采用 保留署名-非商业性使用-禁止演绎 4.0-国际许可协议](https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh)
python
